### What is faithful CoT? 

A reasoning framework involving two stages:
1. Translation (Natural Language query → symbolic reasoning chain) : Uses Language Model
2. Problem Solving (reasoning chain → answer): Uses a deterministic solver respectively. 

[Further Reading](https://arxiv.org/pdf/2301.13379)

### Concepts :

- Faithfulness: (also called fidelity or reliability) means that an explanation should “accurately represent the reasoning process behind the model’s prediction”


```python
# ---------------
# standard setup and imports
# ---------------

from typing import Dict, Any, List, Optional
from pydantic import BaseModel, Field, create_model
from openai import OpenAI
import instructor
import json

# Apply the patch to the OpenAI client
# enables response_model keyword
client = instructor.from_openai(OpenAI())

# -------------o--
# pydantic models
# ---------------


class Question(BaseModel):
    number: int = Field(..., description="question number")
    question: str
    support: Optional[List[str]] = Field(
        default=None,
        description="what part of given question text supports this question",
    )
    dependencies: Optional[List[int]] = Field(
        default=None, description="whether this question depends on any other question"
    )


class QuestionWithPythonCode(BaseModel):
    question: Question
    python_program: str


# ---------------
# step 1: decompose the question in natural language (NL) + symbolic language (SL)
# ---------------


# Function to decompose the user query into sub-questions
async def decompose_query(query: str) -> List:
    decomposition_prompt = f"""
        Q: {query}
        # To solve this question, we answer each of the following subquestions with a Python program:
        """
    print(f"\nDecomposition Prompt:\n{decomposition_prompt}\n")

    sub_questions_response = client.chat.completions.create(
        messages=[{"role": "user", "content": decomposition_prompt}],
        model="gpt-4o",
        response_model=List[QuestionWithPythonCode],
    )

    # Convert Pydantic models to JSON
    json_data = [question.model_dump() for question in sub_questions_response]

    print(f"Sub-Questions Response:\n\n")
    for question in sub_questions_response:
        print(print_format_question(question))
    # print(json.dumps(json_data, indent=4))
    return json_data


# ---------------
# step 2: deterministcally solve the code returned by LLM
# ---------------


# Main function to handle the user query
async def handle_user_query(query: str) -> QuestionWithPythonCode:
    # Step 1: Decompose the query into sub-questions
    print(f"\nHandling User Query:\n{query}\n")
    sub_questions_json = await decompose_query(query)

    # Step 2: Deterministically solve the question
    python_programs = [q["python_program"] for q in sub_questions_json]

    for code_string in python_programs:
        result = solve_it(code_string)
        print(f"Result for code: \t {code_string}\n{result}\n\n")

    return result


def print_format_question(data: QuestionWithPythonCode) -> str:

    question_data = data.question

    first_line = f"Question_number: {question_data.number} {question_data.question} (support: {question_data.support}, dependencies: {question_data.dependencies})"
    second_line = f"python_program: \n {data.python_program }"

    return f"{first_line} \n {second_line}\n"


# ---------------
# solves the python program generated by the model
# ---------------


def solve_it(code_string):
    """
    Solves the cookie code given as a string.

    Args:
        code_string: The string containing the Python code to execute.

    Returns:
        The result of the code execution.

    # Example usage
    code_strings = [
        "oatmeal_cookies_initial = 9\n# After eating 1 oatmeal cookie for snack and 2 more for lunch\noatmeal_cookies_remaining = oatmeal_cookies_initial - 1 - 2\noatmeal_cookies_remaining",
        "chocolate_chip_cookies_initial = 4\n# After eating 1 chocolate chip cookie for snack\nchocolate_chip_cookies_remaining = chocolate_chip_cookies_initial - 1\nchocolate_chip_cookies_remaining",
        "sugar_cookies_initial = 5\n# After eating 1 sugar cookie for snack and giving 2 more to friends\nsugar_cookies_remaining = sugar_cookies_initial - 1 - 2\nsugar_cookies_remaining",
        "# Results from previous questions\noatmeal_cookies_remaining = 6\nchocolate_chip_cookies_remaining = 3\nsugar_cookies_remaining = 2\n# Total cookies left after eating and giving away \ntotal_cookies_remaining = oatmeal_cookies_remaining + chocolate_chip_cookies_remaining + sugar_cookies_remaining\ntotal_cookies_remaining",
        "# Results from previous question\ntotal_cookies_remaining = 11\n# Randy bakes 4 of each flavor (oatmeal, chocolate chip, sugar)\ncookies_baked = 4 * 3 # 3 types of cookies\ntotal_cookies_after_baking = total_cookies_remaining + cookies_baked\ntotal_cookies_after_baking"
    ]

    for code_string in code_strings:
        result = solve_it(code_string)
        print(f"Result for code: {code_string}\n{result}\n")
    """

    # Split the code into lines
    lines = code_string.splitlines()

    # Create a dictionary to store variables
    variables = {}

    # Execute each line of code
    for line in lines:
        if line.startswith("#"):  # Skip comment lines
            continue
        else:
            try:
                # Execute the line as Python code
                exec(line, variables)
            except Exception as e:
                print(f"Error executing line: {line}\nError: {e}")

    # Return the value of the last variable declared
    return variables[line.split("=")[0].strip()]


# Example usage
async def main():
    user_query = "Randy has 9 oatmeal cookies, 4 chocolate chip cookies, and 5 sugar cookies. He ate 3 cookies for an early day snack, one of each flavor. He ate 2 oatmeal cookies for lunch. He gives 2 sugar cookies to his friends. Then, he bakes 4 of each flavor for dinner. How many cookies does he have now?"
    result = await handle_user_query(user_query)


if __name__ == "__main__":
    import asyncio

    asyncio.run(main())

```


```output

Handling User Query:
Randy has 9 oatmeal cookies, 4 chocolate chip cookies, and 5 sugar cookies. He ate 3 cookies for an early day snack, one of each flavor. He ate 2 oatmeal cookies for lunch. He gives 2 sugar cookies to his friends. Then, he bakes 4 of each flavor for dinner. How many cookies does he have now?


Decomposition Prompt:

        Q: Randy has 9 oatmeal cookies, 4 chocolate chip cookies, and 5 sugar cookies. He ate 3 cookies for an early day snack, one of each flavor. He ate 2 oatmeal cookies for lunch. He gives 2 sugar cookies to his friends. Then, he bakes 4 of each flavor for dinner. How many cookies does he have now?
        # To solve this question, we answer each of the following subquestions with a Python program:
        

Sub-Questions Response:


Question_number: 1 How many oatmeal cookies does Randy have after eating 3 cookies for an early day snack, one of each flavor? (support: [], dependencies: []) 
 python_program: 
 initial_oatmeal_cookies = 9
ate_oatmeal_snack = 1
oatmeal_cookies_after_snack = initial_oatmeal_cookies - ate_oatmeal_snack
oatmeal_cookies_after_snack

Question_number: 2 How many chocolate chip cookies does Randy have after eating 3 cookies for an early day snack, one of each flavor? (support: [], dependencies: []) 
 python_program: 
 initial_chocolate_chip_cookies = 4
ate_chocolate_chip_snack = 1
chocolate_chip_cookies_after_snack = initial_chocolate_chip_cookies - ate_chocolate_chip_snack
chocolate_chip_cookies_after_snack

Question_number: 3 How many sugar cookies does Randy have after eating 3 cookies for an early day snack, one of each flavor? (support: [], dependencies: []) 
 python_program: 
 initial_sugar_cookies = 5
ate_sugar_snack = 1
sugar_cookies_after_snack = initial_sugar_cookies - ate_sugar_snack
sugar_cookies_after_snack

Question_number: 4 How many oatmeal cookies does Randy have after eating 2 more for lunch? (support: [], dependencies: [1]) 
 python_program: 
 oatmeal_cookies_after_snack = 8
ate_oatmeal_lunch = 2
oatmeal_cookies_after_lunch = oatmeal_cookies_after_snack - ate_oatmeal_lunch
oatmeal_cookies_after_lunch

Question_number: 5 How many sugar cookies does Randy have after he gives 2 to his friends? (support: [], dependencies: [3]) 
 python_program: 
 sugar_cookies_after_snack = 4
gave_sugar_friends = 2
sugar_cookies_after_giving = sugar_cookies_after_snack - gave_sugar_friends
sugar_cookies_after_giving

Question_number: 6 How many oatmeal cookies does Randy have after baking 4 more for dinner? (support: [], dependencies: [4]) 
 python_program: 
 oatmeal_cookies_after_lunch = 6
baked_oatmeal_cookies = 4
oatmeal_cookies_final = oatmeal_cookies_after_lunch + baked_oatmeal_cookies
oatmeal_cookies_final

Question_number: 7 How many chocolate chip cookies does Randy have after baking 4 more for dinner? (support: [], dependencies: [2]) 
 python_program: 
 chocolate_chip_cookies_after_snack = 3
baked_chocolate_chip_cookies = 4
chocolate_chip_cookies_final = chocolate_chip_cookies_after_snack + baked_chocolate_chip_cookies
chocolate_chip_cookies_final

Question_number: 8 How many sugar cookies does Randy have after baking 4 more for dinner? (support: [], dependencies: [5]) 
 python_program: 
 sugar_cookies_after_giving = 2
baked_sugar_cookies = 4
sugar_cookies_final = sugar_cookies_after_giving + baked_sugar_cookies
sugar_cookies_final

Question_number: 9 How many cookies does Randy have in total after all these activities? (support: [], dependencies: [6, 7, 8]) 
 python_program: 
 oatmeal_cookies_final = 10
chocolate_chip_cookies_final = 7
sugar_cookies_final = 6
total_cookies = oatmeal_cookies_final + chocolate_chip_cookies_final + sugar_cookies_final
total_cookies

------
DETERMINISTICALLY SOLVING 
------

Result for code:         initial_oatmeal_cookies = 9
ate_oatmeal_snack = 1
oatmeal_cookies_after_snack = initial_oatmeal_cookies - ate_oatmeal_snack
oatmeal_cookies_after_snack
8


Result for code:         initial_chocolate_chip_cookies = 4
ate_chocolate_chip_snack = 1
chocolate_chip_cookies_after_snack = initial_chocolate_chip_cookies - ate_chocolate_chip_snack
chocolate_chip_cookies_after_snack
3


Result for code:         initial_sugar_cookies = 5
ate_sugar_snack = 1
sugar_cookies_after_snack = initial_sugar_cookies - ate_sugar_snack
sugar_cookies_after_snack
4


Result for code:         oatmeal_cookies_after_snack = 8
ate_oatmeal_lunch = 2
oatmeal_cookies_after_lunch = oatmeal_cookies_after_snack - ate_oatmeal_lunch
oatmeal_cookies_after_lunch
6


Result for code:         sugar_cookies_after_snack = 4
gave_sugar_friends = 2
sugar_cookies_after_giving = sugar_cookies_after_snack - gave_sugar_friends
sugar_cookies_after_giving
2


Result for code:         oatmeal_cookies_after_lunch = 6
baked_oatmeal_cookies = 4
oatmeal_cookies_final = oatmeal_cookies_after_lunch + baked_oatmeal_cookies
oatmeal_cookies_final
10


Result for code:         chocolate_chip_cookies_after_snack = 3
baked_chocolate_chip_cookies = 4
chocolate_chip_cookies_final = chocolate_chip_cookies_after_snack + baked_chocolate_chip_cookies
chocolate_chip_cookies_final
7


Result for code:         sugar_cookies_after_giving = 2
baked_sugar_cookies = 4
sugar_cookies_final = sugar_cookies_after_giving + baked_sugar_cookies
sugar_cookies_final
6


Result for code:         oatmeal_cookies_final = 10
chocolate_chip_cookies_final = 7
sugar_cookies_final = 6
total_cookies = oatmeal_cookies_final + chocolate_chip_cookies_final + sugar_cookies_final
total_cookies
23


```