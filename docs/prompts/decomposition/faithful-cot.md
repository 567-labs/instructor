### What is faithful CoT? 

A reasoning framework involving two stages:
1. Translation (Natural Language query → symbolic reasoning chain) : Uses Language Model
2. Problem Solving (reasoning chain → answer): Uses a deterministic solver respectively. 

[Further Reading](https://arxiv.org/pdf/2301.13379)

### Concepts :

- Faithfulness: (also called fidelity or reliability) means that an explanation should “accurately represent the reasoning process behind the model’s prediction”


```python
# ---------------
# standard setup and imports
# ---------------

from typing import Dict, Any, List, Optional
from pydantic import BaseModel, Field, create_model
from openai import OpenAI
import instructor
import json 

# Apply the patch to the OpenAI client
# enables response_model keyword
client = instructor.from_openai(OpenAI())


class Question(BaseModel):
    number: int = Field(..., description="question number")
    question: str
    support: Optional[List[str]] = Field(
        default=None,
        description="what part of given question text supports this question",
    )
    dependencies: Optional[List[int]] = Field(
        default=None, description="whether this question depends on any other question"
    )


class QuestionWithPythonCode(BaseModel):
    question: Question
    python_program: str


# Function to decompose the user query into sub-questions
async def decompose_query(query: str) -> List:
    decomposition_prompt = f"""
        Q: {query}
        # To solve this question, we answer each of the following subquestions with a Python program:
        """
    print(f"\nDecomposition Prompt:\n{decomposition_prompt}\n")

    sub_questions_response = client.chat.completions.create(
        messages=[{"role": "user", "content": decomposition_prompt}],
        model="gpt-4o",
        response_model=List[QuestionWithPythonCode],
    )

    # Convert Pydantic models to JSON
    json_data = [question.model_dump() for question in sub_questions_response]

    print(f"Sub-Questions Response:\n\n")
    print(json.dumps(json_data, indent=4))
    return json_data


# Main function to handle the user query
async def handle_user_query(query: str) -> QuestionWithPythonCode:
    # Step 1: Decompose the query into sub-questions
    print(f"\nHandling User Query:\n{query}\n")
    sub_questions_json = await decompose_query(query)

    # Step 2: Deterministically solve the question
    python_programs = [q["python_program"] for q in sub_questions_json]

    for code_string in python_programs:
        result = solve_it(code_string)
        print(f"Result for code: \t {code_string}\n{result}\n\n")

    return result


# solves the python program generated by the model 
def solve_it(code_string):
    """
    Solves the cookie code given as a string.

    Args:
        code_string: The string containing the Python code to execute.

    Returns:
        The result of the code execution.

    # Example usage
    code_strings = [
        "oatmeal_cookies_initial = 9\n# After eating 1 oatmeal cookie for snack and 2 more for lunch\noatmeal_cookies_remaining = oatmeal_cookies_initial - 1 - 2\noatmeal_cookies_remaining",
        "chocolate_chip_cookies_initial = 4\n# After eating 1 chocolate chip cookie for snack\nchocolate_chip_cookies_remaining = chocolate_chip_cookies_initial - 1\nchocolate_chip_cookies_remaining",
        "sugar_cookies_initial = 5\n# After eating 1 sugar cookie for snack and giving 2 more to friends\nsugar_cookies_remaining = sugar_cookies_initial - 1 - 2\nsugar_cookies_remaining",
        "# Results from previous questions\noatmeal_cookies_remaining = 6\nchocolate_chip_cookies_remaining = 3\nsugar_cookies_remaining = 2\n# Total cookies left after eating and giving away \ntotal_cookies_remaining = oatmeal_cookies_remaining + chocolate_chip_cookies_remaining + sugar_cookies_remaining\ntotal_cookies_remaining",
        "# Results from previous question\ntotal_cookies_remaining = 11\n# Randy bakes 4 of each flavor (oatmeal, chocolate chip, sugar)\ncookies_baked = 4 * 3 # 3 types of cookies\ntotal_cookies_after_baking = total_cookies_remaining + cookies_baked\ntotal_cookies_after_baking"
    ]

    for code_string in code_strings:
        result = solve_it(code_string)
        print(f"Result for code: {code_string}\n{result}\n")
    """

    # Split the code into lines
    lines = code_string.splitlines()

    # Create a dictionary to store variables
    variables = {}

    # Execute each line of code
    for line in lines:
        if line.startswith("#"):  # Skip comment lines
            continue
        else:
            try:
                # Execute the line as Python code
                exec(line, variables)
            except Exception as e:
                print(f"Error executing line: {line}\nError: {e}")

    # Return the value of the last variable declared
    return variables[line.split("=")[0].strip()]


# Example usage
async def main():
    user_query = "Randy has 9 oatmeal cookies, 4 chocolate chip cookies, and 5 sugar cookies. He ate 3 cookies for an early day snack, one of each flavor. He ate 2 oatmeal cookies for lunch. He gives 2 sugar cookies to his friends. Then, he bakes 4 of each flavor for dinner. How many cookies does he have now?"
    result = await handle_user_query(user_query)


if __name__ == "__main__":
    import asyncio

    asyncio.run(main())

```


```output

Handling User Query:
Randy has 9 oatmeal cookies, 4 chocolate chip cookies, and 5 sugar cookies. He ate 3 cookies for an early day snack, one of each flavor. He ate 2 oatmeal cookies for lunch. He gives 2 sugar cookies to his friends. Then, he bakes 4 of each flavor for dinner. How many cookies does he have now?


Decomposition Prompt:

        Q: Randy has 9 oatmeal cookies, 4 chocolate chip cookies, and 5 sugar cookies. He ate 3 cookies for an early day snack, one of each flavor. He ate 2 oatmeal cookies for lunch. He gives 2 sugar cookies to his friends. Then, he bakes 4 of each flavor for dinner. How many cookies does he have now?
        # To solve this question, we answer each of the following subquestions with a Python program:
        

Sub-Questions Response:


[
    {
        "question": {
            "number": 1,
            "question": "How many of each type of cookie does Randy have initially?",
            "support": null,
            "dependencies": null
        },
        "python_program": "oatmeal_cookies_initial = 9\nchocolate_chip_cookies_initial = 4\nsugar_cookies_initial = 5\n\ntotal_cookies_initial = {'oatmeal': oatmeal_cookies_initial, 'chocolate_chip': chocolate_chip_cookies_initial, 'sugar': sugar_cookies_initial}\ntotal_cookies_initial"
    },
    {
        "question": {
            "number": 2,
            "question": "How many cookies did Randy eat for an early day snack?",
            "support": [],
            "dependencies": null
        },
        "python_program": "cookies_eaten_snack = 3\ncookies_eaten_snack"
    },
    {
        "question": {
            "number": 3,
            "question": "How many oatmeal cookies did Randy eat for lunch?",
            "support": [],
            "dependencies": null
        },
        "python_program": "cookies_eaten_lunch = 2\noatmeal_cookies_eaten_lunch = cookies_eaten_lunch\noatmeal_cookies_eaten_lunch"
    },
    {
        "question": {
            "number": 4,
            "question": "How many sugar cookies did Randy give to his friends?",
            "support": [],
            "dependencies": null
        },
        "python_program": "sugar_cookies_given_friends = 2\nsugar_cookies_given_friends"
    },
    {
        "question": {
            "number": 5,
            "question": "How many of each type of cookie does Randy have after his snack?",
            "support": null,
            "dependencies": [
                2
            ]
        },
        "python_program": "# Initial cookies\ninitial_cookies = {'oatmeal': 9, 'chocolate_chip': 4, 'sugar': 5}\n\n# Cookies eaten for snack (1 of each type)\ncookies_eaten_snack = {'oatmeal': 1, 'chocolate_chip': 1, 'sugar': 1}\n\n# Cookies left after snack\ncookies_left_after_snack = {cookie: initial_cookies[cookie] - cookies_eaten_snack[cookie] for cookie in initial_cookies}\n\ncookies_left_after_snack"
    },
    {
        "question": {
            "number": 6,
            "question": "How many oatmeal cookies does Randy have after lunch?",
            "support": [],
            "dependencies": [
                3
            ]
        },
        "python_program": "# Cookies after snack\ncookies_left_after_snack = {'oatmeal': 8, 'chocolate_chip': 3, 'sugar': 4}\n\n# Oatmeal cookies eaten for lunch\noatmeal_cookies_eaten_lunch = 2\n\n# Oatmeal cookies left after lunch\noatmeal_cookies_left_after_lunch = cookies_left_after_snack['oatmeal'] - oatmeal_cookies_eaten_lunch\noatmeal_cookies_left_after_lunch"
    },
    {
        "question": {
            "number": 7,
            "question": "How many sugar cookies does Randy have after giving to his friends?",
            "support": [],
            "dependencies": [
                4
            ]
        },
        "python_program": "# Cookies after snack and lunch\noatmeal_cookies_left = 6\nchocolate_chip_cookies_left = 3\nsugar_cookies_left_after_snack = 4\n\n# Sugar cookies given to friends\nsugar_cookies_given_friends = 2\n\n# Sugar cookies left after giving to friends\nsugar_cookies_left_after_giving = sugar_cookies_left_after_snack - sugar_cookies_given_friends\nsugar_cookies_left_after_giving"
    },
    {
        "question": {
            "number": 8,
            "question": "How many cookies of each type does Randy bake for dinner?",
            "support": [],
            "dependencies": null
        },
        "python_program": "cookies_baked_dinner = {'oatmeal': 4, 'chocolate_chip': 4, 'sugar': 4}\ncookies_baked_dinner"
    },
    {
        "question": {
            "number": 9,
            "question": "How many cookies does Randy have in the end?",
            "support": [
                "6"
            ],
            "dependencies": [
                5
            ]
        },
        "python_program": "# Cookies left after giving to friends and eating\ncookies_left = {'oatmeal': 6, 'chocolate_chip': 3, 'sugar': 2}\n\n# Cookies baked for dinner\ncookies_baked_dinner = {'oatmeal': 4, 'chocolate_chip': 4, 'sugar': 4}\n\n# Total cookies\nfinal_cookies = {cookie: cookies_left[cookie] + cookies_baked_dinner[cookie] for cookie in cookies_left}\n\n# Total cookies count\nfinal_cookies_count = sum(final_cookies.values())\nfinal_cookies_count"
    }
]
Result for code:         oatmeal_cookies_initial = 9
chocolate_chip_cookies_initial = 4
sugar_cookies_initial = 5

total_cookies_initial = {'oatmeal': oatmeal_cookies_initial, 'chocolate_chip': chocolate_chip_cookies_initial, 'sugar': sugar_cookies_initial}
total_cookies_initial
{'oatmeal': 9, 'chocolate_chip': 4, 'sugar': 5}


Result for code:         cookies_eaten_snack = 3
cookies_eaten_snack
3


Result for code:         cookies_eaten_lunch = 2
oatmeal_cookies_eaten_lunch = cookies_eaten_lunch
oatmeal_cookies_eaten_lunch
2


Result for code:         sugar_cookies_given_friends = 2
sugar_cookies_given_friends
2


Result for code:         # Initial cookies
initial_cookies = {'oatmeal': 9, 'chocolate_chip': 4, 'sugar': 5}

# Cookies eaten for snack (1 of each type)
cookies_eaten_snack = {'oatmeal': 1, 'chocolate_chip': 1, 'sugar': 1}

# Cookies left after snack
cookies_left_after_snack = {cookie: initial_cookies[cookie] - cookies_eaten_snack[cookie] for cookie in initial_cookies}

cookies_left_after_snack
{'oatmeal': 8, 'chocolate_chip': 3, 'sugar': 4}


Result for code:         # Cookies after snack
cookies_left_after_snack = {'oatmeal': 8, 'chocolate_chip': 3, 'sugar': 4}

# Oatmeal cookies eaten for lunch
oatmeal_cookies_eaten_lunch = 2

# Oatmeal cookies left after lunch
oatmeal_cookies_left_after_lunch = cookies_left_after_snack['oatmeal'] - oatmeal_cookies_eaten_lunch
oatmeal_cookies_left_after_lunch
6


Result for code:         # Cookies after snack and lunch
oatmeal_cookies_left = 6
chocolate_chip_cookies_left = 3
sugar_cookies_left_after_snack = 4

# Sugar cookies given to friends
sugar_cookies_given_friends = 2

# Sugar cookies left after giving to friends
sugar_cookies_left_after_giving = sugar_cookies_left_after_snack - sugar_cookies_given_friends
sugar_cookies_left_after_giving
2


Result for code:         cookies_baked_dinner = {'oatmeal': 4, 'chocolate_chip': 4, 'sugar': 4}
cookies_baked_dinner
{'oatmeal': 4, 'chocolate_chip': 4, 'sugar': 4}


Result for code:         # Cookies left after giving to friends and eating
cookies_left = {'oatmeal': 6, 'chocolate_chip': 3, 'sugar': 2}

# Cookies baked for dinner
cookies_baked_dinner = {'oatmeal': 4, 'chocolate_chip': 4, 'sugar': 4}

# Total cookies
final_cookies = {cookie: cookies_left[cookie] + cookies_baked_dinner[cookie] for cookie in cookies_left}

# Total cookies count
final_cookies_count = sum(final_cookies.values())
final_cookies_count
23
```